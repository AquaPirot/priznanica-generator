<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priznanica</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Priznanica">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg:     #f3f4f6;
            --text:   #1f2937;
            --accent: #6366f1;
            --a-lite: #eef2ff;
            --card:   #ffffff;
            --border: #e5e7eb;
            --muted:  #6b7280;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
        }

        /* ─── SIDEBAR ──────────────────────────────────────────── */
        .sidebar {
            width: 270px;
            flex-shrink: 0;
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .sidebar-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 9px;
            font-weight: 800;
            font-size: 15px;
        }

        .badge {
            margin-left: auto;
            background: var(--a-lite);
            color: var(--accent);
            font-size: 11px;
            font-weight: 700;
            padding: 2px 9px;
            border-radius: 99px;
        }

        .archive-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 16px;
            color: var(--muted);
            font-size: 12px;
            line-height: 1.8;
        }

        .archive-item {
            padding: 11px 13px;
            border-radius: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            background: #f9fafb;
            border: 1.5px solid transparent;
            position: relative;
            transition: background 0.12s;
        }

        .archive-item:hover { background: #f1f2f4; }

        .archive-item.active {
            border-color: var(--accent);
            background: var(--a-lite);
        }

        .ai-name {
            font-weight: 700;
            font-size: 13px;
            padding-right: 22px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ai-sub {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        .del-btn {
            position: absolute;
            right: 7px;
            top: 50%;
            transform: translateY(-50%);
            color: #d1d5db;
            border: none;
            background: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            transition: color 0.12s;
        }

        .del-btn:hover { color: #ef4444; }

        /* ─── MAIN ─────────────────────────────────────────────── */
        .main-wrap {
            flex: 1;
            overflow-y: auto;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 22px;
            padding: 24px;
        }

        /* ─── FORM CARD ─────────────────────────────────────────── */
        .form-card {
            background: var(--card);
            padding: 22px;
            border-radius: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            height: fit-content;
            position: sticky;
            top: 24px;
        }

        .form-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 18px;
        }

        .ig { margin-bottom: 14px; }

        label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 9px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            outline: none;
            background: var(--card);
            color: var(--text);
            transition: border-color 0.12s;
        }

        input:focus, select:focus, textarea:focus { border-color: var(--accent); }

        textarea { resize: none; }

        .two { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

        /* ─── BUTTONS ───────────────────────────────────────────── */
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            transition: transform 0.1s, opacity 0.12s;
            margin-bottom: 8px;
        }

        .btn:last-child { margin-bottom: 0; }
        .btn:active { transform: scale(0.98); }

        .btn-primary   { background: var(--accent); color: white; }
        .btn-secondary { background: var(--bg); color: var(--text); }
        .btn-green     { background: #10b981; color: white; flex: 1; }
        .btn-blue      { background: #0ea5e9; color: white; flex: 1; }

        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }

        .action-row .btn {
            flex: 1;
            width: auto;
            margin-bottom: 0;
            padding: 12px 10px;
        }

        /* ─── RECEIPT PREVIEW ───────────────────────────────────── */
        .preview-wrap { display: flex; flex-direction: column; }

        #receipt-box {
            background: #fff;
            padding: 48px;
            border-radius: 4px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.09);
            color: #111827;
        }

        .r-eyebrow {
            font-size: 10px;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 4px;
        }

        .r-heading {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #9ca3af;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 36px;
        }

        .r-person { margin-bottom: 22px; }

        .r-name {
            font-size: 20px;
            font-weight: 700;
            margin-top: 3px;
        }

        .r-hr {
            border: none;
            border-top: 1px solid #f1f2f4;
            margin: 22px 0;
        }

        .r-amount-box {
            background: #f9fafb;
            padding: 28px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 22px;
        }

        .r-amount-val {
            font-size: 40px;
            font-weight: 800;
            line-height: 1.1;
        }

        .r-amount-words {
            font-size: 12px;
            color: var(--muted);
            font-style: italic;
            margin-top: 6px;
        }

        .r-reason {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 22px;
        }

        .r-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .r-meta-val {
            font-size: 14px;
            font-weight: 600;
            margin-top: 3px;
        }

        .r-footer {
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid #f1f2f4;
            margin-top: 22px;
        }

        /* ─── TOAST ─────────────────────────────────────────────── */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 11px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.22s;
            z-index: 9999;
            white-space: nowrap;
            font-family: 'Inter', sans-serif;
        }

        .toast.show { opacity: 1; }
        .toast.ok  { background: #1f2937; color: white; }
        .toast.err { background: #ef4444; color: white; }

        /* ─── MOBILE FAB ─────────────────────────────────────────── */
        .fab {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(99,102,241,0.45);
            z-index: 100;
            transition: transform 0.1s;
        }

        .fab:active { transform: scale(0.94); }

        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            z-index: 150;
        }

        .overlay.open { display: block; }

        /* ─── RESPONSIVE ─────────────────────────────────────────── */
        @media (max-width: 900px) {
            body { display: block; }

            .sidebar {
                position: fixed;
                left: -290px;
                top: 0;
                height: 100%;
                z-index: 200;
                transition: left 0.25s cubic-bezier(0.4,0,0.2,1);
                box-shadow: none;
            }

            .sidebar.open {
                left: 0;
                box-shadow: 6px 0 24px rgba(0,0,0,0.14);
            }

            .fab { display: flex; }

            .container {
                grid-template-columns: 1fr;
                padding: 14px;
                gap: 14px;
            }

            .form-card { position: static; }

            #receipt-box { padding: 28px; }

            .r-amount-val { font-size: 28px; }

            .action-row { flex-direction: column; }

            .toast { bottom: 20px; }
        }
    </style>
</head>
<body>

<!-- ─── SIDEBAR ───────────────────────────────────────────────────── -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <i data-lucide="archive" style="width:18px;height:18px;"></i>
        Arhiva
        <span class="badge" id="archiveBadge">0</span>
    </div>
    <div class="archive-list" id="archiveList"></div>
</aside>

<!-- Mobile backdrop -->
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<!-- ─── MAIN ──────────────────────────────────────────────────────── -->
<div class="main-wrap">
    <div class="container">

        <!-- FORMA -->
        <div class="form-card">
            <div class="form-title">Nova priznanica</div>

            <div class="ig">
                <label>Novac primio</label>
                <input type="text" id="issuerInp" placeholder="Tvoje ime i prezime">
            </div>

            <div class="ig">
                <label>Novac uplatio</label>
                <input type="text" id="clientInp" placeholder="Ime klijenta">
            </div>

            <div class="two">
                <div class="ig">
                    <label>Iznos</label>
                    <input type="number" id="amountInp" placeholder="0" min="0">
                </div>
                <div class="ig">
                    <label>Valuta</label>
                    <select id="currInp">
                        <option value="RSD">RSD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>

            <div class="ig">
                <label>Svrha</label>
                <textarea id="reasonInp" rows="2" placeholder="Npr. Avans za izradu pergole"></textarea>
            </div>

            <div class="two">
                <div class="ig">
                    <label>Mesto</label>
                    <input type="text" id="placeInp" placeholder="Pirot">
                </div>
                <div class="ig">
                    <label>Datum</label>
                    <input type="date" id="dateInp">
                </div>
            </div>

            <hr class="divider">

            <button class="btn btn-primary" onclick="saveToArchive()">
                <i data-lucide="bookmark-check" style="width:16px;height:16px;"></i>
                Sačuvaj u arhivu
            </button>
            <button class="btn btn-secondary" onclick="newReceipt()">
                <i data-lucide="plus" style="width:16px;height:16px;"></i>
                Nova priznanica
            </button>
        </div>

        <!-- PREVIEW -->
        <div class="preview-wrap">
            <div id="receipt-box">
                <div class="r-heading">Priznanica za primljeni avans</div>

                <div class="r-person">
                    <div class="r-eyebrow">Novac primio</div>
                    <div class="r-name" id="dispIssuer">—</div>
                </div>

                <div class="r-person">
                    <div class="r-eyebrow">Novac uplatio</div>
                    <div class="r-name" id="dispClient">—</div>
                </div>

                <hr class="r-hr">

                <div class="r-amount-box">
                    <div class="r-amount-val" id="dispAmount">0,00 RSD</div>
                    <div class="r-amount-words" id="dispWords">nula dinara</div>
                </div>

                <div class="r-eyebrow">Svrha</div>
                <div class="r-reason" id="dispReason">—</div>

                <div class="r-meta">
                    <div>
                        <div class="r-eyebrow">Mesto</div>
                        <div class="r-meta-val" id="dispPlace">—</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="r-eyebrow">Datum</div>
                        <div class="r-meta-val" id="dispDate">—</div>
                    </div>
                </div>

                <div class="r-footer" id="dispFooter">Br. —</div>
            </div>

            <div class="action-row">
                <button class="btn btn-green" onclick="downloadPng()">
                    <i data-lucide="image-down" style="width:16px;height:16px;"></i>
                    Preuzmi sliku
                </button>
                <button class="btn btn-blue" id="shareBtn" onclick="shareImage()" style="display:none;">
                    <i data-lucide="share-2" style="width:16px;height:16px;"></i>
                    Podeli
                </button>
            </div>
        </div>

    </div>
</div>

<!-- FAB za arhivu na mobilnom -->
<button class="fab" id="fab" onclick="openSidebar()" title="Arhiva">
    <i data-lucide="archive" style="width:20px;height:20px;"></i>
</button>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ─── STATE ──────────────────────────────────────────────────────────────────
let archive = JSON.parse(localStorage.getItem('priv_archive') || '[]');
let activeId = null;
let cachedCanvas = null;

// ─── INIT ────────────────────────────────────────────────────────────────────
lucide.createIcons();

function init() {
    document.getElementById('dateInp').valueAsDate = new Date();
    document.getElementById('issuerInp').value = localStorage.getItem('last_issuer') || '';
    document.getElementById('placeInp').value  = localStorage.getItem('last_place')  || '';

    ['issuerInp','clientInp','amountInp','currInp','reasonInp','placeInp','dateInp']
        .forEach(id => document.getElementById(id).addEventListener('input', () => {
            cachedCanvas = null;
            updatePreview();
        }));

    if (navigator.share) {
        document.getElementById('shareBtn').style.display = '';
    }

    renderArchive();
    updatePreview();

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
}

// ─── PREVIEW ─────────────────────────────────────────────────────────────────
function updatePreview() {
    const issuer = val('issuerInp') || '—';
    const client = val('clientInp') || '—';
    const amount = val('amountInp') || '0';
    const curr   = val('currInp');
    const reason = val('reasonInp') || '—';
    const place  = val('placeInp')  || '—';
    const date   = val('dateInp');

    const fmt = parseFloat(amount).toLocaleString('sr-RS', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

    setText('dispIssuer', issuer);
    setText('dispClient', client);
    setText('dispAmount', `${fmt} ${curr}`);
    setText('dispWords',  `Slovima: ${numToWords(amount, curr)}`);
    setText('dispReason', reason);
    setText('dispPlace',  place);
    setText('dispDate',   fmtDate(date));

    const num = activeId ? getReceiptNum(activeId) : 'Novo';
    setText('dispFooter', `Br. ${num}`);
}

function val(id) { return document.getElementById(id).value; }
function setText(id, t) { document.getElementById(id).textContent = t; }

// ─── ARHIVA ───────────────────────────────────────────────────────────────────
function saveToArchive() {
    const issuer = val('issuerInp').trim();
    const client = val('clientInp').trim();

    if (!issuer || !client) {
        toast('Unesite ko je primio i ko je uplatio.', 'err');
        return;
    }

    const data = {
        id:     activeId || Date.now(),
        num:    activeId ? (archive.find(a => a.id === activeId)?.num || genNum()) : genNum(),
        issuer,
        client,
        amount: val('amountInp'),
        curr:   val('currInp'),
        reason: val('reasonInp'),
        place:  val('placeInp'),
        date:   val('dateInp')
    };

    localStorage.setItem('last_issuer', data.issuer);
    localStorage.setItem('last_place',  data.place);

    if (activeId) {
        const i = archive.findIndex(a => a.id === activeId);
        if (i !== -1) archive[i] = data;
    } else {
        archive.unshift(data);
        activeId = data.id;
    }

    persist();
    renderArchive();
    updatePreview();
    toast('Sačuvano ✓');
}

function renderArchive() {
    const list = document.getElementById('archiveList');
    list.innerHTML = '';

    document.getElementById('archiveBadge').textContent = archive.length;

    if (archive.length === 0) {
        list.innerHTML = '<div class="empty-state">Još nema sačuvanih<br>priznanica</div>';
        return;
    }

    archive.forEach(item => {
        const div = document.createElement('div');
        div.className = 'archive-item' + (activeId === item.id ? ' active' : '');
        div.onclick = () => loadItem(item.id);

        const fmtAmt  = parseFloat(item.amount || 0).toLocaleString('sr-RS', { minimumFractionDigits: 2 });
        const fmtD    = fmtDate(item.date);
        const numDisp = item.num ? `#${item.num} · ` : '';

        div.innerHTML = `
            <button class="del-btn" onclick="deleteItem(event,${item.id})" title="Obriši">
                <i data-lucide="x" style="width:13px;height:13px;"></i>
            </button>
            <div class="ai-name">${esc(item.client || 'Bez imena')}</div>
            <div class="ai-sub">${numDisp}${fmtAmt} ${item.curr} · ${fmtD}</div>
        `;
        list.appendChild(div);
    });

    lucide.createIcons();
}

function loadItem(id) {
    activeId = id;
    const item = archive.find(a => a.id === id);
    if (!item) return;

    document.getElementById('issuerInp').value = item.issuer || '';
    document.getElementById('clientInp').value = item.client || '';
    document.getElementById('amountInp').value = item.amount || '';
    document.getElementById('currInp').value   = item.curr   || 'RSD';
    document.getElementById('reasonInp').value = item.reason || '';
    document.getElementById('placeInp').value  = item.place  || '';
    document.getElementById('dateInp').value   = item.date   || '';

    cachedCanvas = null;
    updatePreview();
    renderArchive();
    closeSidebar();
}

function deleteItem(e, id) {
    e.stopPropagation();
    if (!confirm('Obrisati ovu priznanicu iz arhive?')) return;
    archive = archive.filter(a => a.id !== id);
    if (activeId === id) newReceipt();
    persist();
    renderArchive();
    toast('Obrisano');
}

function newReceipt() {
    activeId = null;
    cachedCanvas = null;
    ['clientInp','amountInp','reasonInp'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('dateInp').valueAsDate = new Date();
    updatePreview();
    renderArchive();
}

function persist() {
    localStorage.setItem('priv_archive', JSON.stringify(archive));
}

// Generise stabilan redni broj (ne menja se brisanjem)
function genNum() {
    const next = (parseInt(localStorage.getItem('receipt_seq') || '0')) + 1;
    localStorage.setItem('receipt_seq', next);
    return String(next).padStart(3, '0');
}

function getReceiptNum(id) {
    return archive.find(a => a.id === id)?.num || '???';
}

// ─── DOWNLOAD / SHARE ────────────────────────────────────────────────────────
function makeCanvas() {
    return html2canvas(document.getElementById('receipt-box'), {
        scale: 3,
        backgroundColor: '#ffffff',
        logging: false
    });
}

function downloadPng() {
    const btn = event.currentTarget;
    btn.disabled = true;

    makeCanvas().then(canvas => {
        cachedCanvas = canvas;
        const client = val('clientInp').replace(/\s+/g, '-').toLowerCase() || 'priznanica';
        const num    = activeId ? getReceiptNum(activeId) : 'novo';
        const link   = document.createElement('a');
        link.download = `priznanica-${client}-${num}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        toast('Slika preuzeta ✓');
    }).finally(() => { btn.disabled = false; });
}

async function shareImage() {
    try {
        const canvas = cachedCanvas || await makeCanvas();
        cachedCanvas = canvas;

        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
        const client = val('clientInp') || 'priznanica';
        const num    = activeId ? getReceiptNum(activeId) : 'novo';
        const file   = new File([blob], `priznanica-${client}-${num}.png`, { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ title: 'Priznanica za avans', files: [file] });
        } else {
            downloadPng();
        }
    } catch (err) {
        if (err.name !== 'AbortError') downloadPng();
    }
}

// ─── MOBILE SIDEBAR ───────────────────────────────────────────────────────────
function openSidebar() {
    document.getElementById('sidebar').classList.add('open');
    document.getElementById('overlay').classList.add('open');
}

function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
}

// ─── TOAST ────────────────────────────────────────────────────────────────────
let _tt = null;
function toast(msg, type = 'ok') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = `toast ${type} show`;
    clearTimeout(_tt);
    _tt = setTimeout(() => el.classList.remove('show'), 2500);
}

// ─── HELPERS ──────────────────────────────────────────────────────────────────
function fmtDate(str) {
    if (!str) return '—';
    // T12:00:00 sprečava timezone bug koji pomera dan za -1
    const d = new Date(str + 'T12:00:00');
    if (isNaN(d.getTime())) return '—';
    return d.toLocaleDateString('sr-RS');
}

function esc(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── NUMBER TO WORDS (ispravka za 10.000+) ────────────────────────────────────
function numToWords(n, curr) {
    if (!n || parseFloat(n) == 0) return 'nula ' + (curr === 'RSD' ? 'dinara' : 'evra');

    const units    = ['','jedan','dva','tri','četiri','pet','šest','sedam','osam','devet'];
    const teens    = ['deset','jedanaest','dvanaest','trinaest','četrnaest','petnaest',
                      'šesnaest','sedamnaest','osamnaest','devetnaest'];
    const tens     = ['','','dvadeset','trideset','četrdeset','pedeset',
                      'šezdeset','sedamdeset','osamdeset','devedeset'];
    const hundreds = ['','sto','dvesta','trista','četiristo','petsto',
                      'šesto','sedamsto','osamsto','devetsto'];

    // Pretvara broj 1-999 u reči
    function tri(num) {
        let out = '';
        if (num >= 100) { out += hundreds[Math.floor(num / 100)] + ' '; num %= 100; }
        if (num >= 20)  { out += tens[Math.floor(num / 10)] + ' '; num %= 10; }
        else if (num >= 10) { out += teens[num - 10] + ' '; num = 0; }
        if (num > 0) out += units[num] + ' ';
        return out;
    }

    let num = parseInt(n);
    if (num >= 1000000) return 'iznos prevelik za prikaz';

    let out = '';

    if (num >= 1000) {
        const th = Math.floor(num / 1000);
        if      (th === 1) out += 'hiljadu ';
        else if (th === 2) out += 'dve hiljade ';
        else if (th < 5)   out += units[th] + ' hiljade ';
        else if (th < 10)  out += units[th] + ' hiljada ';
        else               out += tri(th) + 'hiljada ';   // ← fix za 10k+
        num %= 1000;
    }

    out += tri(num);
    return out.trim() + ' ' + (curr === 'RSD' ? 'dinara' : 'evra');
}

init();
</script>
</body>
</html>
